<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Adesto Flash Driver Reference Package: SPI Layer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="https://www.adestotech.com/"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href=https://github.com/adestotechnologies/Flash-Drivers style="color:black">Adesto Flash Driver Reference Package
   </div>
   <div id="projectbrief">Sample SPI drivers for a number of the Adesto Technologies flash devices.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part --><!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">SPI Layer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The SPI layer is used as a SPI driver to communicate with the flash device. This is accomplished through the use of <a href="https://en.wikipedia.org/wiki/Bit_banging">bit-banging</a>. As such, the SPI layer is built on top of a functional MCU specific GPIO driver. Once a GPIO driver has been connected to this layer (see the <a class="el" href="_u_s_e_r__c_o_n_f_i_g_u_r_a_t_i_o_n__d_e_s_c_r_i_p_t_i_o_n.html">User Configuration</a> guide for a how-to), function calls from the Adesto or SPI layers should work. Code for the SPI layer consists of a header and c file which contain functions for single, dual, and quad SPI communication. Adesto layer commands access the SPI layer to communicate with the flash device. The SPI layer calls functions from the user configurable <a class="el" href="user__config_8h.html" title="Project declarations exist here. ">user_config.h</a> and <a class="el" href="user__config_8c.html" title="Project definitions exist here. ">user_config.c</a> files. See the <a class="el" href="_u_s_e_r__c_o_n_f_i_g_u_r_a_t_i_o_n__d_e_s_c_r_i_p_t_i_o_n.html">User Configuration</a> documentation for more details.<br />
<br />
 Reading and writing to the the IOs occurs after the falling edge of the clock but before the rising edge in the current implementation of the SPI drivers. This behavior can be seen within the <a class="el" href="spi__driver_8c.html#a9cdbe217fe5a1b913b21286daeaeb5b1" title="Receives a byte along MISO and returns the value received. ">SPI_ReceiveByte()</a> and <a class="el" href="spi__driver_8c.html#a72ac0633e04a5c40107d1e4e57f9196b" title="Sends a byte along MOSI. ">SPI_SendByte()</a> functions where data is sampled or written, then the clock toggled from low to high.<br />
<br />
 Users are intended to access the larger SPI transactions functions which handle the order of bytes transmitted, configuration of the IOs, and bit/byte shifting. These functions allow the user to shape the SPI transaction to include dummy bytes and communicate portions of the message using 1, 2, or 4 IOs. These transactions are accomplished through the following 3 functions calls:</p><ol type="1">
<li><a class="el" href="spi__driver_8c.html#a16fbd6043228ac91a69a5303e51499e5" title="Sends and receives bytes based on the function parameters. MISO and MOSI fill their standard SPI role...">SPI_Exchange()</a></li>
<li><a class="el" href="spi__driver_8c.html#abbbd859b7c1d944dbb3515a3d1986ec2" title="Sends and receives bytes based on the function parameters. MOSI is used for the opcode and address...">SPI_DualExchange()</a></li>
<li><a class="el" href="spi__driver_8c.html#abadb0ea0c16bbddb7f0810f24e7632a9" title="Sends and receives bytes based on the function parameters. MOSI can used for the opcode and address...">SPI_QuadExchange()</a></li>
</ol>
<p>Documentation for each of these functions details how the specifics of each argument and how the transaction is carried out. In summary, the user passes in 2 byte arrays; one for trasnmitting and one for receiving. The user also specifies the number of bytes being transmitted or received from 0-N (N being determined usually by the page size of the device being used, but ultimately variable and dependant on what the user needs). The number of dummy bytes is also passed in, the value independant of the transmitted number of bytes. The dual and quad exchange functions include another parameter which determines the number of bytes from the MCU transmitted SPI exchange to be sent in single SPI (transmission along MOSI alone). This number must be less than or equal to the total number of transmitted bytes. With this variable the user can send a quad or dual communication in a range of formats from 1-1-2 to 4-4-4 or even 0-4-4 (opcode-address-data, values representing the number of IOs used in the transaction of each component). For example, a user wishes to send a 1-byte opcode along MOSI, a 3-byte address along 4 IOs, 2 dummy bytes after the address, and receive a 5-byte data packet along 4 IOs. This transaction would be classified as 1-4-4, and the corresponding function call would look like this:</p>
<div class="fragment"><div class="line"><a class="code" href="spi__driver_8c.html#abadb0ea0c16bbddb7f0810f24e7632a9">SPI_QuadExchange</a>(1, txBuffer, 4, rxBuffer, 5, 2) </div></div><!-- fragment --><p>The arguments in order are explained as follows:</p><ol type="1">
<li><b>1</b> - The single opcode byte sent in standard SPI along MOSI.</li>
<li><b>txBuffer</b> - A pointer to the buffer containing the opcode and 3 address bytes.</li>
<li><b>4</b> - The total number of bytes being transmitted; 4. 1 for opcode and 3 for address.</li>
<li><b>rxBufer</b> - A pointer to the array where the received data will be stored.</li>
<li><b>5</b> - The total number of bytes to be received; 5 bytes.</li>
<li><b>2</b> - The number of dummy bytes being transmitted; 2 bytes.</li>
</ol>
<p>Since only 1 byte is sent in standard SPI mode, all communication after the opcode is done with 4 IOs, <b>including</b> the dummy bytes. The transaction looks like this when viewed with a logic analyzer:</p>
<div class="image">
<img src="quad_exchange144.png" alt="quad_exchange144.png"/>
</div>
 <center><b>Quad Exchange:</b> Sample SPI transaction showing a 1-4-4 communication via <a class="el" href="spi__driver_8c.html#abadb0ea0c16bbddb7f0810f24e7632a9" title="Sends and receives bytes based on the function parameters. MOSI can used for the opcode and address...">SPI_QuadExchange()</a>.</center><p>Note the number of clocks used for each portion of the transaction. For a 1-4-4 communication the opcode is clocked out 1 bit at a time, followed by a nibble on each clock for the address, dummy, and data bytes.</p>
<h1><a class="anchor" id="SPI_LAYER_LINKS"></a>
File Links</h1>
<p><a class="el" href="group___s_p_i___l_a_y_e_r.html">SPI Layer</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
<!-- Generated by &#160;<a href="https://www.adestotech.com/"> -->
	<a href=license.html>
	Clear BSD License Copyright Â©2018 Adesto Technologies Corporation, Inc. All rights reserved.
</small></address>
</body>
</html>